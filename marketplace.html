<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="styles/index.css" />

    <link rel="import" id="loading-template" href="templates/loading.html">

    <script src="scripts/utils/ajax.es6.js"></script>
    <script src="scripts/utils/format.es6.js"></script>
</head>

<body>
<header class="page-header">
    <div class="wrapper">
        <a class="logo" title="coincogs" href="http://localhost:4000"><img src="" alt /></a>
        <div class="top-nav">
            <div class="input-group search">
                <input type="text" placeholder="Type your reference, year, metal..." /><button title="Click to search"><i class="fa fa-search" aria-hidden="true"></i></button>
            </div>
            <a class="toggle-button" href="marketplace.html">
                <input type="checkbox" id="marketplace"/>
                <label for="marketplace"><span>Marketplace</span><i class="fa fa-caret-down" aria-hidden="true"></i></label>
            </a>
            <div  class="toggle-button">
                <input type="checkbox" id="community"/>
                <label for="community"><span>Community</span><i class="fa fa-caret-down" aria-hidden="true"></i></i></label>
            </div>
        </nav>
    </div>
</header>

<div class="page-content marketplace">
    <div class="wrapper">
        <div class="page-nav">
            <div class="tab-bar">
    <ul>
        <li class="link selected"><a>Toutes les pièces</a></li>
        <li><a class="link">Pièces souhaitées</a></li>
        <li><a class="link">Achats</a></li>
        <li><a class="link">Panier</a></li>
    </ul>
</div>
            <div class="nav-bar">
    <label>Trier par</label>
    <select>
        <option value="RecentDescending" selected>Mise en vente la plus récente</option>
        <option value="RecentAscending">Mise en vente la plus ancienne</option>
        <option value="FaceValueAscending">Pièces de A-Z</option>
        <option value="FaceValueDescending">Pièces de Z-A</option>
    </select>
    <div>
        <a>&lsaquo;</a>
        <span>-</span>
        <a>&rsaquo;</a>
    </div>
</div>
        </div>
        <div class="two-column one-fifth">
            <div>
                <div class="marketplace-filter-container">
    <figure class="filters empty">
        <figcaption>Filtres</figcaption>
        <ul></ul>
    </figure>
</div>


<script type="text/javascript">
    var mfc = {

        raiseFilterSelected : function(filterText) {
            if(!filterText) return;

            this.node.dispatchEvent(new CustomEvent('filterSelected', { bubbles: true, cancelable: false, detail: filterText }));
        },

        raiseFilterRemoved : function(filterText) {
            if(!filterText) return;

            this.node.dispatchEvent(new CustomEvent('filterRemoved', { bubbles: true, cancelable: false, detail: filterText }));
        },

        selectFilterHandler : function(evt) {
            var target  = (evt.target || evt.srcElement);
            while(target != null && target.tagName != 'A') target  = target.parentNode;

            var filterText  = (target.querySelector('.title') || {}).innerText;
            if(!filterText) return;

            // keep a track of the filter text
            this.filters.push(filterText);

            // append a new filter node as a UI feedback
            var newFilterNode = document.createElement('li');
            newFilterNode.innerHTML = `<a><span class="title">${filterText}</span><span class="cross" title="Remove filter">&times;</span></a>`;
            newFilterNode.boundTo = target.parentNode;
            this.filterNode.appendChild(newFilterNode);

            target.parentNode.classList.add('selected');

            newFilterNode.querySelector('a').addEventListener('click', this.removeFilterProxy);

            // 
            this.raiseFilterSelected(filterText);

            // 
            if(this.filterNode.parentNode.classList.contains('empty')) {
                this.filterNode.parentNode.classList.remove('empty');
            }
        },

        removeFilterHandler : function(evt) {
            var target  = (evt.target || evt.srcElement);
            while(target != null && target.tagName != 'LI') target  = target.parentNode;

            if(target != null) {
                if(target.boundTo) {
                    target.boundTo.classList.remove('selected');
                    target.boundTo = null;
                } 

                // unregister properly all DOM stuff
                target.querySelector('a').removeEventListener('click', this.removeFilterProxy);
                this.filterNode.removeChild(target);

                // remove kept filter text
                var filterText  = (target.querySelector('.title') || {}).innerText;
                if(this.filters.indexOf(filterText) != -1) this.filters.splice(this.filters.indexOf(filterText), 1);   
                this.raiseFilterRemoved(filterText);

                // 
                if(!this.filterNode.hasChildNodes()) {
                    this.filterNode.parentNode.classList.add('empty');
                }
            }
        },

        moreFilterHandler : function(evt) {
            var target  = (evt.target || evt.srcElement);
            while(target != null && target.tagName != 'A') target  = target.parentNode;

            if(!target) return;

            var list = target.parentNode.querySelector('ul');
            if(list.classList.length == 0) {
                list.classList.add('six-filters');
            }
            else if(list.classList.contains('six-filters')) {
                list.classList.add('all-filters');
            }

            // check if there are still few 'hidden' filters
            this.checkFilterButtonVisibility(target.parentNode);
        },

        checkFilterButtonVisibility: function(filterGroup) {
            if(!filterGroup) return;

            var list = filterGroup.querySelector('ul');
            var more = filterGroup.querySelector('.more');
            if(!list || !more) return;

            var contentHeight = 0;
            Array.from(list.querySelectorAll('li:not(.hidden)')).forEach(function(li) { contentHeight += li.offsetHeight; });

            if(contentHeight <= list.offsetHeight) {
                more.classList.add('hidden');
            }
            else {
                more.classList.remove('hidden');
            }
        },

        gatherFilters : function(url) {
            var self = this;

            Ajax.getJSON(url, false).then(function(data) {
                if(data && data.length) {

                    var existingFilterGroupNodes = Array.from(self.node.querySelectorAll('figure:not(.filters)'));

                    if(existingFilterGroupNodes.length == 0) {
                        // append new filters
                        data.forEach(function(filterGroupInfo) {

                            var newFilterGroupHtml = `<figcaption>${filterGroupInfo.title}</figcaption><ul>`;
                            filterGroupInfo.filters.forEach(function(filter) {
                                var filterTitle = filter.title;
                                var filterCount = Format.formatInteger(filter.count, 'fr-FR');
                                newFilterGroupHtml += `<li><a><span class="title">${filterTitle}</span><span class="count">${filterCount}</span></a></li>`;
                            });
                            newFilterGroupHtml += `</ul><a class="more">+ ${filterGroupInfo.more_label}</a>`;

                            var newFilterGroupNode = document.createElement('figure');
                            newFilterGroupNode.innerHTML = newFilterGroupHtml;

                            self.node.appendChild(newFilterGroupNode);
                        });

                        self.registerHandlers();
                    }
                    else {
                        // hide/remove previous filters
                        existingFilterGroupNodes.forEach(function(filterGroupNode, groupIndex) {
                            var filterGroupInfo = data[groupIndex];

                            Array.from(filterGroupNode.querySelectorAll('li')).forEach(function(li, liIndex) {

                                var liTitle = (li.querySelector('.title') || {}).innerHTML;
                                var filterInfo = filterGroupInfo.filters.find(function(fi) { return fi.title == liTitle });

                                if(!filterInfo){
                                    li.classList.add('hidden');
                                } 
                                else {
                                    li.classList.remove('hidden');
                                    
                                    // update and show count values
                                    var liCount = li.querySelector('.count');
                                    liCount.innerHTML = Format.formatInteger(filterInfo.count, 'fr-FR');
                                }
                            });

                            window.setTimeout(function() { self.checkFilterButtonVisibility(filterGroupNode); }, 0);
                        });
                    }
                }
            }, function() {
                
            });
        },

        registerHandlers : function() {
            if(!this.selectFilterProxy) {
                var self = this;
                this.selectFilterProxy = function() { self.selectFilterHandler.apply(self, [...arguments]); }
                this.removeFilterProxy = function() { self.removeFilterHandler.apply(self, [...arguments]); }
                this.moreFilterProxy = function() { self.moreFilterHandler.apply(self, [...arguments]); }
            }

            Array.from(this.node.querySelectorAll('a:not(.more)')).forEach(function(a) {
                a.addEventListener('click', this.selectFilterProxy);
            }, this);

            Array.from(this.node.querySelectorAll('a.more')).forEach(function(a) {
                a.addEventListener('click', this.moreFilterProxy);
            }, this);
        },

        unregisterHandlers : function() {
            var self = this;

            Array.from(this.node.querySelectorAll('a.title')).forEach(function(a) {
                a.removeEventListener('click', self.selectFilterProxy);
            }, this);
        },

        init: function() {
            this.node = document.querySelector('.marketplace-filter-container');
            this.filterNode = this.node.querySelector('.filters ul');
            this.filters = [];

            this.gatherFilters('http://localhost:8080/marketplace/filters.json');
        }
    };

    mfc.init();


    // for testing purpose only
    mfc.node.addEventListener('filterSelected', function(evt) {
        mfc.gatherFilters('http://localhost:8080/marketplace/filters_' + mfc.filters.join('_').toLowerCase() + '.json');

        if(mrc) {
            mrc.gatherResults('http://localhost:8080/marketplace/results_' + mfc.filters.join('_').toLowerCase() + '.json');
        }
    });
    mfc.node.addEventListener('filterRemoved', function(evt) {
        if(mfc.filters.length > 0){
            mfc.gatherFilters('http://localhost:8080/marketplace/filters_' + mfc.filters.join('_').toLowerCase() + '.json');

            if(mrc) {
                mrc.gatherResults('http://localhost:8080/marketplace/results_' + mfc.filters.join('_').toLowerCase() + '.json');
            }
        }
        else {
            mfc.gatherFilters('http://localhost:8080/marketplace/filters.json');

            if(mrc) {
                mrc.gatherResults('http://localhost:8080/marketplace/results_1.json');
            }
        }
    });
    
</script>
            </div>
            <div>
                <div class="marketplace-result-container">
    <div class="result-header">
        <span></span>
        <a class="sort">Description</a>
        <a class="sort">Année</a>
        <a class="sort">Etat <i class="fa fa-caret-down" aria-hidden="true"></i></a>
        <a class="sort">Vendeur</a>
        <a class="sort">Prix</a>
    </div>

    <ul class="result-list table six-cols">
        <li class="row">
            <div class="cell"><a class="link"><img src="images/1849a_1_franc_avers.png" alt/><img src="images/1849a_1_franc_revers.png" alt/></a></div>
            <div class="cell">
                <a class="link title">1 Franc Céres</a>
                <div><span>Métal :</span><span>Argent 900‰</span><span>Poids :</span><span>5 g</span></div>
                <div><span>Tranche :</span><span>Cannelée</span></div>
                <div><span>Graveur :</span><span>Eugène-André Oudiné</span></div>
            </div>
            <div class="cell"><span class="year">1849 A</span></div>
            <div class="cell"><span class="grade">SUP</span></div>
            <div class="cell">
                <a class="link seller" href="user_profile_reviews.html">@michu</a>
                <div class="seller rating">
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <a class="link">150 notes</a>
                </div>
                <div><span>Expédié de :</span><span>Bordeaux</span></div>
            </div>
            <div class="cell">
                <span class="price">150 €</span>
                <span class="price">+ 2.5 €</span>
                <a class="button buy" title="Ajouter au panier"><i class="fa fa-cart-arrow-down" aria-hidden="true"></i></a>
            </div>
        </li>
        <li class="row">
            <div class="cell"><a class="link"><img src="images/1866k_1_franc_avers.png" alt/><img src="images/1866k_1_franc_revers.png" alt/></a></div>
            <div class="cell">
                <a class="link title">1 Franc Napoléon III tête laurée</a>
                <div><span>Métal :</span><span>Argent 835‰</span><span>Poids :</span><span>5 g</span></div>
                <div><span>Tranche :</span><span>Cannelée</span></div>
                <div><span>Graveur :</span><span>Désiré-Albert Barre</span></div>
            </div>
            <div class="cell"><span class="year">1866 K</span></div>
            <div class="cell"><span class="grade">SUP</span></div>
            <div class="cell">
                <a class="link seller" href="user_profile_reviews.html">@pika</a>
                 <div class="seller rating">
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <a class="link">72 notes</a>
                </div>
                <div><span>Expédié de :</span><span>Marseille</span></div>
            </div>
            <div class="cell">
                <span class="price">200 €</span>
                <span class="price">gratuit</span>
                <a class="button buy" title="Ajouter au panier"><i class="fa fa-cart-arrow-down" aria-hidden="true"></i></a>
            </div>
        </li>
        <li class="row">
            <div class="cell"><a class="link"><img src="images/1898_2_franc_avers.png" alt/><img src="images/1898_2_franc_revers.png" alt/></a></div>
            <div class="cell">
                <a class="link title">2 Francs Semeuse</a>
                <div><span>Métal :</span><span>Argent 835‰</span><span>Poids :</span><span>10 g</span></div>
                <div><span>Tranche :</span><span>Cannelée</span></div>
                <div><span>Graveur :</span><span>Louis-Oscar Roty</span></div>
            </div>
            <div class="cell"><span class="year">1898 FM</span></div>
            <div class="cell"><span class="grade">SPL</span></div>
            <div class="cell">
                <a class="link seller" href="user_profile_reviews.html">@pika</a>
                <div class="seller rating">
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <a class="link">72 notes</a>
                </div>
                <div><span>Expédié de :</span><span>Marseille</span></div>
            </div>
            <div class="cell">
                <span class="price">350 €</span>
                <span class="price">gratuit</span>
                <a class="button buy" title="Ajouter au panier"><i class="fa fa-cart-arrow-down" aria-hidden="true"></i></a>
            </div>
        </li>
        <li class="row">
            <div class="cell"><a class="link"><img src="images/1849a_1_franc_avers.png" alt/><img src="images/1849a_1_franc_revers.png" alt/></a></div>
            <div class="cell">
                <a class="link title">1 Franc Céres</a>
                <div><span>Métal :</span><span>Argent 900‰</span><span>Poids :</span><span>5 g</span></div>
                <div><span>Tranche :</span><span>Cannelée</span></div>
                <div><span>Graveur :</span><span>Eugène-André Oudiné</span></div>
            </div>
            <div class="cell"><span class="year">1849 A</span></div>
            <div class="cell"><span class="grade">SUP</span></div>
            <div class="cell">
                <a class="link seller">@michu</a>
                <div class="seller rating">
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <a class="link">150 notes</a>
                </div>
                <div><span>Expédié de :</span><span>Bordeaux</span></div>
            </div>
            <div class="cell">
                <span class="price">150 €</span>
                <a class="button buy" title="Ajouter au panier"><i class="fa fa-cart-arrow-down" aria-hidden="true"></i></a>
            </div>
        </li>
        <li class="row">
            <div class="cell"><a class="link"><img src="images/1866k_1_franc_avers.png" alt/><img src="images/1866k_1_franc_revers.png" alt/></a></div>
            <div class="cell">
                <a class="link title">1 Franc Napoléon III tête laurée</a>
                <div><span>Métal :</span><span>Argent 835‰</span><span>Poids :</span><span>5 g</span></div>
                <div><span>Tranche :</span><span>Cannelée</span></div>
                <div><span>Graveur :</span><span>Désiré-Albert Barre</span></div>
            </div>
            <div class="cell"><span class="year">1866 K</span></div>
            <div class="cell"><span class="grade">SUP</span></div>
            <div class="cell">
                <a class="link seller">@pika</a>
                 <div class="seller rating">
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <a class="link">72 notes</a>
                </div>
                <div><span>Expédié de :</span><span>Marseille</span></div>
            </div>
            <div class="cell">
                <span class="price">200 €</span>
                <a class="button buy" title="Ajouter au panier"><i class="fa fa-cart-arrow-down" aria-hidden="true"></i></a>
            </div>
        </li>
        <li class="row">
            <div class="cell"><a class="link"><img src="images/1898_2_franc_avers.png" alt/><img src="images/1898_2_franc_revers.png" alt/></a></div>
            <div class="cell">
                <a class="link title">2 Francs Semeuse</a>
                <div><span>Métal :</span><span>Argent 835‰</span><span>Poids :</span><span>10 g</span></div>
                <div><span>Tranche :</span><span>Cannelée</span></div>
                <div><span>Graveur :</span><span>Louis-Oscar Roty</span></div>
            </div>
            <div class="cell"><span class="year">1898 FM</span></div>
            <div class="cell"><span class="grade">SPL</span></div>
            <div class="cell">
                <a class="link seller">@pika</a>
                <div class="seller rating">
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <a class="link">72 notes</a>
                </div>
                <div><span>Expédié de :</span><span>Marseille</span></div>
            </div>
            <div class="cell">
                <span class="price">350 €</span>
                <a class="button buy" title="Ajouter au panier"><i class="fa fa-cart-arrow-down" aria-hidden="true"></i></a>
            </div>
        </li>
        <li class="row">
            <div class="cell"><a class="link"><img src="images/1849a_1_franc_avers.png" alt/><img src="images/1849a_1_franc_revers.png" alt/></a></div>
            <div class="cell">
                <a class="link title">1 Franc Céres</a>
                <div><span>Métal :</span><span>Argent 900‰</span><span>Poids :</span><span>5 g</span></div>
                <div><span>Tranche :</span><span>Cannelée</span></div>
                <div><span>Graveur :</span><span>Eugène-André Oudiné</span></div>
            </div>
            <div class="cell"><span class="year">1849 A</span></div>
            <div class="cell"><span class="grade">SUP</span></div>
            <div class="cell">
                <a class="link seller">@michu</a>
                <div class="seller rating">
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <a class="link">150 notes</a>
                </div>
                <div><span>Expédié de :</span><span>Bordeaux</span></div>
            </div>
            <div class="cell">
                <span class="price">150 €</span>
                <a class="button buy" title="Ajouter au panier"><i class="fa fa-cart-arrow-down" aria-hidden="true"></i></a>
            </div>
        </li>
        <li class="row">
            <div class="cell"><a class="link"><img src="images/1866k_1_franc_avers.png" alt/><img src="images/1866k_1_franc_revers.png" alt/></a></div>
            <div class="cell">
                <a class="link title">1 Franc Napoléon III tête laurée</a>
                <div><span>Métal :</span><span>Argent 835‰</span><span>Poids :</span><span>5 g</span></div>
                <div><span>Tranche :</span><span>Cannelée</span></div>
                <div><span>Graveur :</span><span>Désiré-Albert Barre</span></div>
            </div>
            <div class="cell"><span class="year">1866 K</span></div>
            <div class="cell"><span class="grade">SUP</span></div>
            <div class="cell">
                <a class="link seller">@pika</a>
                 <div class="seller rating">
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <a class="link">72 notes</a>
                </div>
                <div><span>Expédié de :</span><span>Marseille</span></div>
            </div>
            <div class="cell">
                <span class="price">200 €</span>
                <a class="button buy" title="Ajouter au panier"><i class="fa fa-cart-arrow-down" aria-hidden="true"></i></a>
            </div>
        </li>
        <li class="row">
            <div class="cell"><a class="link"><img src="images/1898_2_franc_avers.png" alt/><img src="images/1898_2_franc_revers.png" alt/></a></div>
            <div class="cell">
                <a class="link title">2 Francs Semeuse</a>
                <div><span>Métal :</span><span>Argent 835‰</span><span>Poids :</span><span>10 g</span></div>
                <div><span>Tranche :</span><span>Cannelée</span></div>
                <div><span>Graveur :</span><span>Louis-Oscar Roty</span></div>
            </div>
            <div class="cell"><span class="year">1898 FM</span></div>
            <div class="cell"><span class="grade">SPL</span></div>
            <div class="cell">
                <a class="link seller">@pika</a>
                <div class="seller rating">
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <i class="fa fa-star" aria-hidden="true"></i>
                    <a class="link">72 notes</a>
                </div>
                <div><span>Expédié de :</span><span>Marseille</span></div>
            </div>
            <div class="cell">
                <span class="price">350 €</span>
                <a class="button buy" title="Ajouter au panier"><i class="fa fa-cart-arrow-down" aria-hidden="true"></i></a>
            </div>
        </li>
    </ul>
</div>

<script type="text/javascript">

    function syncNavHeaderAndList() {
        var container = document.querySelector('.marketplace-result-container .result-list');
        //var containerStyle = container.currentStyle || window.getComputedStyle(container);
        
        var nav = document.querySelector('.page-nav');
        var header = document.querySelector('.marketplace-result-container .result-header');

        nav.style.width = container.offsetWidth + 'px';
        header.style.width = container.offsetWidth + 'px';
    }

    window.addEventListener('resize', syncNavHeaderAndList);

    syncNavHeaderAndList();
</script>
            </div>
        </div>
    </div>
</div>

<footer class="page-footer"></footer>
<script type="text/javascript">
    function updatePageNavLayout() {
        var content = document.querySelector('.page-content');
        var wrapper = content.querySelector('.wrapper');
        var pagenav = content.querySelector('.page-nav');
        
        if(pagenav && content) pagenav.style.width = (wrapper.offsetWidth - (content.offsetWidth - content.clientWidth)) + 'px';
    }

    updatePageNavLayout();

    window.addEventListener('resize', updatePageNavLayout);
</script>
</body>
</html>